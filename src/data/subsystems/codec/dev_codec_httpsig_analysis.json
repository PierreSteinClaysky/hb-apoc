{
  "name": "`dev_codec_httpsig",
  "subsystem": "codec",
  "filename": "dev_codec_httpsig.erl",
  "content": "# `dev_codec_httpsig.erl` Analysis\r\n\r\n\n\n## Overview\r\n\r\n`dev_codec_httpsig.erl` implements HTTP Message Signatures as described in RFC-9421 as a Converge device in HyperBEAM. This module serves as both a codec (message format converter) and an attestation mechanism, providing cryptographic message verification capabilities that form a critical part of HyperBEAM's security infrastructure.\r\n\r\nThe module effectively bridges the gap between HTTP-based protocols and HyperBEAM's internal message format, enabling secure, verifiable communication across network boundaries. It implements the complex rules of HTTP Message Signatures, including component derivation, signature base construction, and cryptographic verification, while maintaining compatibility with HTTP standards.\r\n\r\nAs noted in its documentation, the module divides its functionality into two main areas:\r\n1. **Attestation functions** (`id/3`, `attest/3`, `verify/3`, etc.) implemented directly in this module\r\n2. **Codec functions** (`to/1`, `from/1`) which are relayed to the `dev_codec_httpsig_conv` module\r\n\r\n\n\n## Key Characteristics\r\n\r\n- **HTTP Standards Compliant**: Implements RFC-9421 (HTTP Message Signatures) with precise attention to specification details\r\n- **Dual-Role Functionality**: Provides both message format conversion and cryptographic attestation\r\n- **Component-Based Signing**: Enables fine-grained control over which message components are included in signatures\r\n- **Multiple Signature Support**: Accommodates multiple attestors signing the same message\r\n- **Format-Aware Processing**: Handles HTTP Structured Fields (RFC 8941) with careful parsing and serialization\r\n- **Cryptographic Algorithms**: Supports RSA-PSS-SHA512 for signatures and HMAC-SHA256 for integrity\r\n- **Derived Component Support**: Handles HTTP-specific derived components like `@method`, `@target-uri`, etc.\r\n\r\n\n\n## Dependencies\r\n\r\n### Upstream Dependencies\r\n\r\n- `hb_structured_fields`: For parsing and serializing HTTP Structured Fields\r\n- `hb_converge`: For message resolution and normalization\r\n- `hb_message`: For message format conversion\r\n- `hb_util`: For encoding/decoding and utility functions\r\n- `hb_crypto`: For cryptographic operations\r\n- `hb_opts`: For configuration access\r\n- `ar_wallet`: For Arweave wallet integration and signing\r\n\r\n\n\n## Implementation Details\r\n\r\n### Message Signing Process\r\n\r\nThe `attest/3` function implements the core message signing process:\r\n\r\n```erlang\r\nattest(MsgToSign, _Req, Opts) ->\r\n    Wallet = hb_opts:get(priv_wallet, no_viable_wallet, Opts),\r\n    NormMsg = hb_converge:normalize_keys(MsgToSign),\r\n    % ... (handling hashpath and preparing the message) ...\r\n    EncWithoutBodyKeys = maps:without(\r\n        [<<\"signature\">>, <<\"signature-input\">>, <<\"body-keys\">>, <<\"priv\">>],\r\n        hb_message:convert(MsgWithoutHP, <<\"httpsig@1.0\">>, Opts)\r\n    ),\r\n    Enc = add_content_digest(EncWithoutBodyKeys),\r\n    Authority = authority(lists:sort(maps:keys(Enc)), SigParams, Wallet),\r\n    {ok, {SignatureInput, Signature}} = sign_auth(Authority, #{}, Enc),\r\n    % ... (creating attestation and updating the message) ...\r\n    reset_hmac(MsgWithoutHP#{<<\"attestations\">> =>\r\n        OldAttestations#{ Attestor => Attestation }\r\n    }).\r\n```\r\n\r\nThis function:\r\n1. Obtains the wallet for signing\r\n2. Normalizes and converts the message to HTTP format\r\n3. Adds a content digest for the message body\r\n4. Creates an \"authority\" with component identifiers and signature parameters\r\n5. Generates the signature base and signs it\r\n6. Creates an attestation with the signature and signature input\r\n7. Updates the message with the new attestation\r\n\r\n### Signature Verification\r\n\r\nThe `verify/3` function handles signature verification:\r\n\r\n```erlang\r\nverify(MsgToVerify, #{ <<\"attestor\">> := <<\"hmac-sha256\">> }, _Opts) ->\r\n    % ... (HMAC verification logic) ...\r\nverify(MsgToVerify, Req, _Opts) ->\r\n    % Validate a signed attestation.\r\n    Attestor = maps:get(<<\"attestor\">>, Req),\r\n    SigName = address_to_sig_name(Attestor),\r\n    % ... (parsing signature parameters) ...\r\n    case Alg of\r\n        {string, <<\"rsa-pss-sha512\">>} ->\r\n            {string, KeyID} = maps:get(<<\"keyid\">>, Params),\r\n            PubKey = hb_util:decode(KeyID),\r\n            % ... (preparing the message) ...\r\n            Res = verify_auth(\r\n                #{\r\n                    key => {{rsa, 65537}, PubKey},\r\n                    sig_name => address_to_sig_name(Address)\r\n                },\r\n                EncWithDigest\r\n            ),\r\n            {ok, Res};\r\n        _ -> {error, {unsupported_alg, Alg}}\r\n    end.\r\n```\r\n\r\nThe function:\r\n1. Distinguishes between HMAC and signature verification\r\n2. For signatures, extracts the public key from the signature parameters\r\n3. Prepares the message in the same format as was used for signing\r\n4. Generates the signature base and verifies the signature\r\n\r\n### Signature Base Construction\r\n\r\nThe construction of the signature base is a critical part of the implementation:\r\n\r\n```erlang\r\nsignature_base(Authority, Req, Res) when is_map(Authority) ->\r\n    ComponentIdentifiers = maps:get(component_identifiers, Authority),\r\n    ComponentsLine = signature_components_line(ComponentIdentifiers, Req, Res),\r\n    ParamsLine = signature_params_line(\r\n        ComponentIdentifiers,\r\n        maps:get(sig_params, Authority)),\r\n    SignatureBase = join_signature_base(ComponentsLine, ParamsLine),\r\n    {ParamsLine, SignatureBase}.\r\n```\r\n\r\nThis follows the RFC-9421 specification for creating a signature base, which consists of:\r\n1. Component lines for each field or derived component being signed\r\n2. A signature parameters line with the list of components and parameters\r\n\r\n### Component Extraction\r\n\r\nThe module handles extracting component values from HTTP messages:\r\n\r\n```erlang\r\nextract_field({item, {_Kind, IParsed}, IParams}, Req, Res) ->\r\n    % ... (parameter parsing) ...\r\n    Lowered = lower_bin(IParsed),\r\n    NormalizedItem = hb_structured_fields:item(\r\n        {item, {string, Lowered}, IParams}\r\n    ),\r\n    IsRequestIdentifier = find_request_param(IParams),\r\n    case maps:get(Lowered, if IsRequestIdentifier -> Req; true -> Res end, not_found) of\r\n        not_found -> {field_not_found_error, ...};\r\n        FieldValue -> \r\n            % ... (field value extraction) ...\r\n    end.\r\n```\r\n\r\nThis function carefully:\r\n1. Normalizes field names (case-insensitive)\r\n2. Determines whether to extract from request or response\r\n3. Handles error cases according to the specification\r\n4. Applies special processing for structured fields and dictionary keys\r\n\r\n### Derived Components\r\n\r\nThe module supports HTTP-specific derived components:\r\n\r\n```erlang\r\nderive_component(Identifier, Req, Res) ->\r\n    % ... \r\n    case Lowered of\r\n        <<\"@method\">> -> {ok, upper_bin(maps:get(<<\"method\">>, Req, <<>>))};\r\n        <<\"@target-uri\">> -> {ok, bin(maps:get(<<\"path\">>, Req, <<>>))};\r\n        <<\"@authority\">> -> ... \r\n        % ... (more derived components) ...\r\n    end\r\n```\r\n\r\nThese derived components follow RFC-9421's specifications for extracting standard HTTP message components like method, target URI, and status.\r\n\r\n\n\n## Integration with Other Subsystems\r\n\r\n### Integration with Network Communication Subsystem\r\n\r\n- Provides signature capabilities for HTTP messages sent and received through the network stack\r\n- Handles verification of incoming signed messages\r\n- Enables content integrity verification through content digests\r\n\r\n### Integration with Core Infrastructure\r\n\r\n- Uses the Converge protocol for message resolution\r\n- Leverages message conversion capabilities for format translation\r\n- Integrates with Arweave wallet for cryptographic operations\r\n\r\n### Integration with Device and Process Management Subsystem\r\n\r\n- Functions as a device within the device system\r\n- Supports the attestation model used by process management",
  "description": "`dev_codec_httpsig.erl` implements HTTP Message Signatures as described in RFC-9421 as a Converge device in HyperBEAM. This module serves as both a codec (message format converter) and an attestation mechanism, providing cryptographic message verification capabilities that form a critical part of HyperBEAM's security infrastructure.",
  "hasCode": true
}